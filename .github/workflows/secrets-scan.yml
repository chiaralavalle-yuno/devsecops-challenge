name: Secrets Scan

on:
  push:
    branches: ["**"]
  pull_request:
    types: [opened, synchronize, reopened]

# Minimal permissions — read-only access to contents + ability to post PR comments
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # ============================================================
  # Gitleaks — primary scanner with custom rules
  # Scans full git history on push, diff only on PR
  # ============================================================
  gitleaks:
    name: Gitleaks Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history for accurate scanning)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history required for gitleaks to check all commits

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}  # Optional — free tier works
        with:
          config: .gitleaks.toml

  # ============================================================
  # TruffleHog — secondary scanner (defense-in-depth)
  # Scans PR diff only (not full history) to minimize false positives.
  #
  # Trade-off: TruffleHog without --only-verified catches more secrets
  # (including unverified/high-entropy strings) but generates more false
  # positives on config files. .trufflehogignore mitigates this.
  # Gitleaks with custom pattern rules provides the authoritative verdict.
  # TruffleHog is defense-in-depth.
  # ============================================================
  trufflehog:
    name: TruffleHog Secret Scan
    runs-on: ubuntu-latest
    # Only run on PRs — diff-based scan is not applicable to direct pushes
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog (PR diff only)
        uses: trufflesecurity/trufflehog@main
        with:
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          extra_args: --only-verified=false
          # .trufflehogignore is applied automatically when present at repo root

  # ============================================================
  # Post actionable comment on scan failure
  # ============================================================
  post-failure-comment:
    name: Post Remediation Comment
    runs-on: ubuntu-latest
    needs: [gitleaks, trufflehog]
    if: failure() && github.event_name == 'pull_request'
    steps:
      - name: Post remediation comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const body = `## :rotating_light: Secret Detected — Action Required

            A secret scanner found a potential credential in this pull request.

            ### Immediate Steps

            1. **Identify the secret**: Check the failed job logs above for the specific file and line number.
            2. **Remove it from the diff**: The secret must not be merged into \`main\`.
            3. **Rotate it NOW** (even before fixing the code): If this secret was ever pushed to GitHub, assume it is compromised.
            4. **Use an environment variable instead**:
               \`\`\`python
               # BAD — never do this
               api_key = "bsur_abc123..."

               # GOOD — reference from environment
               api_key = os.environ["BANCOSUR_API_KEY"]
               \`\`\`
            5. **Add to \`.env\`** (gitignored): \`BANCOSUR_API_KEY=your_value\`
            6. **For production secrets**: Store in Vault or AWS Secrets Manager, fetch at runtime.

            ### If This Is a False Positive

            - Add an allowlist entry to \`.gitleaks.toml\` with a comment explaining why it's safe.
            - For TruffleHog: add to \`.trufflehogignore\`.
            - **Never use \`git commit --no-verify\`** to bypass this check.

            ### Resources

            - [Rotation Runbook](../docs/rotation-runbook.md)
            - [Gitleaks allowlist docs](https://github.com/gitleaks/gitleaks#configuration)
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body,
            });
