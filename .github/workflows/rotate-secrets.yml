name: Rotate Secrets

on:
  # Manual trigger with provider + backend selection
  workflow_dispatch:
    inputs:
      provider:
        description: "Provider to rotate"
        type: choice
        options: [bancosur, walletpro, all]
        required: true
        default: bancosur
      backend:
        description: "Secrets backend"
        type: choice
        options: [vault, aws]
        required: true
        default: vault
      force_fail:
        description: "Force rotation failure (test rollback)"
        type: boolean
        default: false

  # Quarterly automated rotation (1st of Jan, Apr, Jul, Oct at 02:00 UTC)
  # PCI-DSS Req 12.3 — periodic credential rotation
  schedule:
    - cron: "0 2 1 */3 *"

# Permissions required for OIDC authentication to AWS (documented, not active in demo)
permissions:
  id-token: write   # OIDC token for AWS assume-role
  contents: read

jobs:
  rotate:
    name: Rotate ${{ inputs.provider || 'all' }} (${{ inputs.backend || 'vault' }})
    runs-on: ubuntu-latest

    # GitHub Environment with required reviewer approval
    # Configure at: Settings → Environments → secrets-rotation
    # - Add required reviewers (security team)
    # - Restrict to main branch only
    # - Add VAULT_ADDR and VAULT_TOKEN as environment secrets
    environment: secrets-rotation

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install rotation dependencies
        run: pip install -r rotation/requirements.txt

      # --------------------------------------------------------
      # Vault backend (active in CI demo)
      # VAULT_ADDR and VAULT_TOKEN are GitHub Environment Secrets
      # --------------------------------------------------------
      - name: Configure Vault connection
        if: ${{ inputs.backend == 'vault' || github.event_name == 'schedule' }}
        env:
          VAULT_ADDR: ${{ secrets.VAULT_ADDR }}
          VAULT_TOKEN: ${{ secrets.VAULT_TOKEN }}
        run: |
          echo "VAULT_ADDR=$VAULT_ADDR" >> $GITHUB_ENV
          echo "VAULT_ROLE_ID_ROTATION_AGENT=${{ secrets.VAULT_ROLE_ID_ROTATION_AGENT }}" >> $GITHUB_ENV
          echo "VAULT_SECRET_ID_ROTATION_AGENT=${{ secrets.VAULT_SECRET_ID_ROTATION_AGENT }}" >> $GITHUB_ENV
          echo "MOCK_PROVIDER_URL=${{ vars.MOCK_PROVIDER_URL || 'http://localhost:5003' }}" >> $GITHUB_ENV
          echo "PAYMENTS_API_URL=${{ vars.PAYMENTS_API_URL || 'http://localhost:5001' }}" >> $GITHUB_ENV
          echo "WEBHOOKS_SERVICE_URL=${{ vars.WEBHOOKS_SERVICE_URL || 'http://localhost:5002' }}" >> $GITHUB_ENV

      # --------------------------------------------------------
      # AWS backend (OIDC — documented, not active in demo)
      # See: aws/oidc-setup.md for setup instructions
      # --------------------------------------------------------
      - name: Configure AWS credentials via OIDC
        if: ${{ inputs.backend == 'aws' }}
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.ROTATION_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}
          role-session-name: GitHubActionsRotation
        # This step is intentionally left inactive in the demo.
        # Enable it after completing aws/oidc-setup.md.

      # --------------------------------------------------------
      # Run rotation
      # --------------------------------------------------------
      - name: Run secret rotation
        env:
          SECRETS_BACKEND: ${{ inputs.backend || 'vault' }}
        run: |
          PROVIDER="${{ inputs.provider || 'all' }}"
          BACKEND="${{ inputs.backend || 'vault' }}"
          FORCE_FAIL_FLAG=""
          if [ "${{ inputs.force_fail }}" == "true" ]; then
            FORCE_FAIL_FLAG="--force-fail"
          fi

          echo "Rotating provider: $PROVIDER on backend: $BACKEND"
          python rotation/rotate.py \
            --provider "$PROVIDER" \
            --backend "$BACKEND" \
            $FORCE_FAIL_FLAG

      # --------------------------------------------------------
      # Upload audit log as artifact
      # --------------------------------------------------------
      - name: Upload audit log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: audit-log-${{ github.run_number }}
          path: audit/audit.log
          if-no-files-found: ignore
          retention-days: 90  # PCI-DSS Req 10.7 — 1 year for production

      # --------------------------------------------------------
      # Post rotation summary to GitHub Actions summary
      # --------------------------------------------------------
      - name: Summarize rotation
        if: always()
        run: |
          echo "## Rotation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Provider | ${{ inputs.provider || 'all (scheduled)' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ inputs.backend || 'vault' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Actor | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Run | [${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f audit/audit.log ]; then
            echo "### Audit Events" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            tail -20 audit/audit.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
